<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sailing Savers · Article</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>⛵️</text></svg>">
  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">
  <main class="max-w-3xl mx-auto px-4 py-10">
    <button onclick="history.back()" 
      class="mb-6 px-4 py-2 rounded-lg border border-slate-300 hover:bg-slate-100">← Back</button>

    <article id="article" class="bg-white border border-slate-200 rounded-2xl p-6 shadow-sm prose max-w-none">
      <h1 id="title" class="mb-2">Loading…</h1>
      <p id="excerpt" class="text-slate-600"></p>
      <img id="cover" class="my-4 rounded-xl hidden" alt="Cover image" />
      <div id="body"></div>
    </article>
  </main>

  <script>
    let supabase;
    async function initSupabase(){
      const res = await fetch('/.netlify/functions/public-config');
      const { SUPABASE_URL, SUPABASE_ANON_KEY } = await res.json();
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }

    async function loadArticle(){
      const params = new URLSearchParams(location.search);
      const slug = params.get('slug');
      if (!slug) {
        document.getElementById('title').textContent = "Article not found";
        return;
      }

      const { data, error } = await supabase
        .from('articles')
        .select('*')
        .eq('slug', slug)
        .maybeSingle();

      if (error || !data){
        document.getElementById('title').textContent = "Article not found";
        return;
      }

      document.getElementById('title').textContent = data.title;
      document.getElementById('excerpt').textContent = data.excerpt || '';
      if (data.cover_url){
        const img = document.getElementById('cover');
        img.src = data.cover_url;
        img.classList.remove('hidden');
      }
      document.getElementById('body').innerHTML = marked.parse(data.body || '');
    }

    (async function(){
      await initSupabase();
      await loadArticle();
    })();
  </script>
</body>
</html>