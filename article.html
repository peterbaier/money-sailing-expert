<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Article · Sailing Savers</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <main class="max-w-3xl mx-auto px-4 py-10">
    <a href="/" class="text-ocean-700 underline">← Back</a>
    <h1 id="title" class="text-3xl font-bold mt-4"></h1>
    <p id="meta" class="text-sm text-slate-600 mt-1"></p>
    <div id="tags" class="mt-2 flex flex-wrap gap-2"></div>
    <article id="body" class="prose max-w-none mt-6"></article>
    <div id="notfound" class="hidden mt-10 text-slate-600">Sorry, that article wasn’t found.</div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // read slug from /slug or ?slug=slug
    const pathSlug = location.pathname.replace(/^\\//,'').replace(/\\/$/,'');
    const urlSlug = new URLSearchParams(location.search).get('slug');
    const slug = pathSlug && pathSlug !== 'article.html' ? pathSlug : urlSlug;

    let supabase;
    async function initSupabase(){
      const res = await fetch('/.netlify/functions/public-config', { cache: 'no-store' });
      const { SUPABASE_URL, SUPABASE_ANON_KEY } = await res.json();
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }

    function pill(t){ const s = document.createElement('span'); s.className='text-xs px-2 py-0.5 rounded-full bg-slate-100 border border-slate-200'; s.textContent=t; return s; }

    (async function boot(){
      await initSupabase();
      if (!slug){ document.getElementById('notfound').classList.remove('hidden'); return; }
      const { data, error } = await supabase
        .from('articles')
        .select('title,excerpt,category,tags,minutes,body,published_at')
        .eq('slug', slug)
        .not('published_at','is',null)
        .lte('published_at', new Date().toISOString())
        .maybeSingle();

      if (error || !data){ document.getElementById('notfound').classList.remove('hidden'); return; }

      document.title = `${data.title} · Sailing Savers`;
      document.getElementById('title').textContent = data.title;
      document.getElementById('meta').textContent = `${data.category||''} • ⏱️ ${data.minutes||0} min`;
      const tg = document.getElementById('tags');
      (data.tags||[]).forEach(t => tg.appendChild(pill(t)));
      document.getElementById('body').innerHTML = marked.parse(data.body||'');
    })();
  </script>
</body>
</html>
