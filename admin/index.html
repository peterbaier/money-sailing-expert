<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sailing Savers · Admin Editor</title>
  <meta name="description" content="Admin editor with live Markdown preview." />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>⛵️</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { colors: { ocean:{50:'#eef8ff',100:'#d8f0ff',200:'#b9e3ff',300:'#8dd0ff',400:'#56b5ff',500:'#2996f5',600:'#1976d2',700:'#155fa9',800:'#124f8b',900:'#0f406f'}, kelp:{500:'#1d7a59'} } } } }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .card { transition: transform .2s ease, box-shadow .2s ease; }
    .card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,.08); }
  </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">
  <!-- Top bar -->
  <header class="sticky top-0 z-40 backdrop-blur bg-white/80 border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <a href="/" class="flex items-center gap-2 font-semibold text-ocean-800">
        <span class="text-2xl">⛵️</span>
        <span class="text-lg tracking-tight">Sailing Savers — Admin</span>
      </a>
      <div class="ml-auto flex items-center gap-2 text-sm">
        <span id="userEmail" class="text-slate-600"></span>
        <button id="signOut" class="rounded-xl px-3 py-1.5 border border-slate-300 hover:bg-slate-50">Sign out</button>
      </div>
    </div>
  </header>

  <!-- Main layout -->
  <main class="max-w-7xl mx-auto px-4 py-6 grid lg:grid-cols-2 gap-6">
    <!-- Editor -->
    <section class="card bg-white border border-slate-200 rounded-2xl p-6">
      <h1 class="text-xl font-bold mb-4">Article editor</h1>
      <form id="editor" class="space-y-4">
        <div class="grid md:grid-cols-2 gap-4">
          <label class="block">
            <span class="text-sm font-medium text-slate-700">Title</span>
            <input id="title" class="mt-1 w-full rounded-xl border-slate-300 focus:border-ocean-500 focus:ring-ocean-500" placeholder="Budget Antifouling: Save 40%…" required />
          </label>
          <label class="block">
            <span class="text-sm font-medium text-slate-700">Slug</span>
            <input id="slug" class="mt-1 w-full rounded-xl border-slate-300 font-mono focus:border-ocean-500 focus:ring-ocean-500" placeholder="budget-antifouling" required />
            <p class="text-xs text-slate-500 mt-1">Auto-generated from title — you can edit.</p>
          </label>
        </div>

        <label class="block">
          <span class="text-sm font-medium text-slate-700">Excerpt</span>
          <textarea id="excerpt" rows="2" class="mt-1 w-full rounded-xl border-slate-300 focus:border-ocean-500 focus:ring-ocean-500" placeholder="Short teaser shown in lists"></textarea>
        </label>

        <div class="grid md:grid-cols-3 gap-4">
          <label class="block">
            <span class="text-sm font-medium text-slate-700">Category</span>
            <select id="category" class="mt-1 w-full rounded-xl border-slate-300 focus:border-ocean-500 focus:ring-ocean-500">
              <option>Maintenance</option>
              <option>Painting</option>
              <option>Fibreglass</option>
              <option>Budget</option>
              <option>Safety</option>
              <option>DIY</option>
            </select>
          </label>
          <label class="block">
            <span class="text-sm font-medium text-slate-700">Read time (min)</span>
            <input id="minutes" type="number" min="1" value="6" class="mt-1 w-full rounded-xl border-slate-300 focus:border-ocean-500 focus:ring-ocean-500" />
          </label>
          <label class="block">
            <span class="text-sm font-medium text-slate-700">Tags</span>
            <input id="tagsInput" class="mt-1 w-full rounded-xl border-slate-300 focus:border-ocean-500 focus:ring-ocean-500" placeholder="antifouling, paint, money" />
            <div id="tags" class="mt-2 flex flex-wrap gap-2"></div>
          </label>
        </div>

        <label class="block">
          <span class="text-sm font-medium text-slate-700">Body (Markdown)</span>
          <textarea id="body" rows="14" class="mt-1 w-full rounded-xl border-slate-300 font-mono leading-6 focus:border-ocean-500 focus:ring-ocean-500" placeholder="## Heading\nYour content here…"></textarea>
        </label>

        <div class="flex items-center gap-3">
          <button id="saveBtn" type="submit" class="rounded-xl px-5 py-3 bg-kelp-500 text-white hover:brightness-95">Save</button>
          <button id="resetBtn" type="button" class="rounded-xl px-5 py-3 border border-slate-300 hover:bg-slate-50">Reset</button>
          <span id="saveStatus" class="text-sm text-slate-500"></span>
        </div>
      </form>
    </section>

    <!-- Preview -->
    <aside class="card bg-white border border-slate-200 rounded-2xl p-6">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-bold">Preview</h2>
        <label class="text-sm text-slate-600"><input id="autoPreview" type="checkbox" class="mr-2" checked /> Auto-update</label>
      </div>
      <article class="prose max-w-none mt-4">
        <h3 id="pTitle" class="text-2xl font-semibold">—</h3>
        <p id="pExcerpt" class="text-slate-600">—</p>
        <div class="mt-2 flex items-center gap-2 text-xs text-slate-600">
          <span id="pCategory" class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-slate-100 border border-slate-200">Category</span>
          <span id="pTags" class="flex flex-wrap gap-2"></span>
          <span id="pMinutes" class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-slate-100 border border-slate-200">⏱️ 0 min</span>
        </div>
        <hr class="my-4" />
        <div id="pBody" class="prose"></div>
      </article>
    </aside>
  </main>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 hidden">
    <div class="rounded-xl bg-ocean-900 text-white px-4 py-2 shadow-lg">Saved!</div>
  </div>

  <script>
    // ======= Supabase init (runtime via Netlify function) =======
    let supabase;
    async function initSupabase(){
      const res = await fetch('/.netlify/functions/public-config', { cache: 'no-store' });
      if(!res.ok){ alert('Failed to load config'); return; }
      const { SUPABASE_URL, SUPABASE_ANON_KEY } = await res.json();
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }

    // ======= Guard: admin only =======
    async function requireAdmin(){
      const { data: { user } } = await supabase.auth.getUser();
      if(!user){ location.assign('/admin/login.html'); return false; }
      const { data, error } = await supabase.from('profiles').select('is_admin').eq('id', user.id).maybeSingle();
      if(error || !data?.is_admin){ await supabase.auth.signOut(); location.assign('/admin/login.html'); return false; }
      document.getElementById('userEmail').textContent = user.email || '';
      return true;
    }

    // ======= Auth top-right =======
    document.getElementById('signOut').onclick = async ()=>{ await supabase.auth.signOut(); location.assign('/admin/login.html'); };

    // ======= Editor state =======
    const el = id => document.getElementById(id);
    const title = el('title');
    const slug = el('slug');
    const excerpt = el('excerpt');
    const category = el('category');
    const minutes = el('minutes');
    const tagsInput = el('tagsInput');
    const tagsWrap = el('tags');
    const body = el('body');
    const saveBtn = el('saveBtn');
    const saveStatus = el('saveStatus');

    let current = { slug:'', title:'', excerpt:'', category:'Maintenance', minutes:6, tags:[], body:'' };

    function toSlug(s){ return s.toLowerCase().trim().replace(/[^a-z0-9\s-]/g,'').replace(/\s+/g,'-').replace(/-+/g,'-'); }

    title.addEventListener('input', ()=>{ if(!slug.dataset.touched){ slug.value = toSlug(title.value); } updatePreview(); });
    slug.addEventListener('input', ()=>{ slug.dataset.touched = '1'; });

    function renderTags(list){
      tagsWrap.innerHTML = '';
      (list||[]).forEach((t,i)=>{
        const b = document.createElement('button');
        b.type = 'button'; b.className = 'inline-flex items-center gap-1 px-2 py-1 rounded-full bg-slate-100 border border-slate-200 text-xs';
        b.textContent = t; b.title = 'Remove tag';
        b.onclick = ()=>{ current.tags.splice(i,1); renderTags(current.tags); updatePreview(); };
        tagsWrap.appendChild(b);
      })
    }

    tagsInput.addEventListener('keydown', (e)=>{
      if(e.key==='Enter' || e.key===','){
        e.preventDefault();
        const v = tagsInput.value.trim().replace(/,$/,'');
        if(v && !current.tags.includes(v)) current.tags.push(v);
        tagsInput.value=''; renderTags(current.tags); updatePreview();
      }
    });

    const autoPreview = el('autoPreview');
    const pTitle = el('pTitle');
    const pExcerpt = el('pExcerpt');
    const pCategory = el('pCategory');
    const pTags = el('pTags');
    const pMinutes = el('pMinutes');
    const pBody = el('pBody');

    function updatePreview(){
      if(!autoPreview.checked) return;
      pTitle.textContent = title.value || '—';
      pExcerpt.textContent = excerpt.value || '—';
      pCategory.textContent = category.value || '—';
      pTags.innerHTML = (current.tags||[]).map(t=>`<span class='inline-flex items-center gap-1 px-2 py-1 rounded-full bg-slate-100 border border-slate-200 text-xs'>${t}</span>`).join(' ');
      pMinutes.textContent = `⏱️ ${Number(minutes.value||0)} min`;
      pBody.innerHTML = marked.parse(body.value || '');
    }

    function syncToForm(a){
      current = { ...current, ...a };
      title.value = a.title||'';
      slug.value = a.slug||'';
      excerpt.value = a.excerpt||'';
      category.value = a.category || 'Maintenance';
      minutes.value = a.minutes || 6;
      body.value = a.body || '';
      renderTags(a.tags||[]);
      updatePreview();
    }

    el('resetBtn').onclick = ()=>{ syncToForm({ slug:'', title:'', excerpt:'', category:'Maintenance', minutes:6, tags:[], body:'' }); };

    el('editor').addEventListener('submit', async (e)=>{
      e.preventDefault();
      saveBtn.disabled = true; saveStatus.textContent = 'Saving…';
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) { saveBtn.disabled=false; saveStatus.textContent=''; return alert('Session expired. Please sign in again.'); }

      const payload = {
        slug: slug.value.trim(),
        title: title.value.trim(),
        excerpt: excerpt.value.trim(),
        body: body.value,
        category: category.value,
        tags: current.tags,
        minutes: Number(minutes.value||6)
      };
      if(!payload.slug || !payload.title){ saveBtn.disabled=false; saveStatus.textContent=''; return alert('Title and slug are required.'); }

      const res = await fetch('/.netlify/functions/upsert-article', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}` },
        body: JSON.stringify(payload)
      });
      const txt = await res.text();
      saveBtn.disabled = false; saveStatus.textContent = '';
      if(!res.ok) return alert(txt);
      showToast('Saved');
    });

    function showToast(msg){
      const t = document.getElementById('toast');
      t.firstElementChild.textContent = msg;
      t.classList.remove('hidden');
      setTimeout(()=> t.classList.add('hidden'), 1400);
    }

    // ======= Boot =======
    (async function boot(){
      await initSupabase();
      supabase.auth.onAuthStateChange(async ()=>{
        const { data:{ user } } = await supabase.auth.getUser();
        if(!user) location.assign('/admin/login.html');
      });
      if(!(await requireAdmin())) return; // will redirect if not admin
      syncToForm(current);
      updatePreview();
    })();
  </script>
</body>
</html>
