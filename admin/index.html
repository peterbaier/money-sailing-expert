<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sailing Savers · Admin Editor</title>
  <meta name="description" content="Admin-only editor with live Markdown preview and Netlify + Supabase wiring." />
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>⛵️</text></svg>" />
  <!-- Tailwind + Typography plugin for .prose -->
  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            ocean: {
              50: "#eef8ff",
              100: "#d8f0ff",
              200: "#b9e3ff",
              300: "#8dd0ff",
              400: "#56b5ff",
              500: "#2996f5",
              600: "#1976d2",
              700: "#155fa9",
              800: "#124f8b",
              900: "#0f406f",
            },
            kelp: {
              500: "#1d7a59"
            },
          },
        },
      },
    };
  </script>
  <!-- Markdown renderer + Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .card {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
    }

    /* Slightly bigger headings inside preview */
    .prose h1 {
      font-size: 1.875rem;
      line-height: 2.25rem;
    }

    .prose h2 {
      font-size: 1.5rem;
      line-height: 2rem;
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-900 min-h-screen">
  <!-- Top bar -->
  <header class="sticky top-0 z-40 backdrop-blur bg-white/80 border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <a href="/" class="flex items-center gap-2 font-semibold text-ocean-800">
        <span class="text-2xl">⛵️</span>
        <span class="text-lg tracking-tight">Sailing Savers — Admin</span>
      </a>
      <div class="ml-auto flex items-center gap-2 text-sm">
        <span id="userEmail" class="text-slate-600"></span>
        <button id="signOut" class="rounded-xl px-3 py-1.5 border border-slate-300 hover:bg-slate-50">
          Sign out
        </button>
      </div>
    </div>
  </header>

  <!-- Main layout -->
  <main class="max-w-7xl mx-auto px-4 py-6 grid lg:grid-cols-2 gap-6">
    <!-- Editor -->
    <section class="card bg-white border border-slate-200 rounded-2xl p-6">
      <h1 class="text-xl font-bold mb-4">Article editor</h1>
      <form id="editor" class="space-y-4">
        <div class="grid md:grid-cols-2 gap-4">
          <label class="block">
            <span class="text-sm font-medium text-slate-700">Title</span>
            <input id="title"
              class="mt-1 w-full rounded-xl border-slate-300 focus:border-ocean-500 focus:ring-ocean-500"
              placeholder="Budget Antifouling: Save 40%…" required />
          </label>
          <label class="block">
            <span class="text-sm font-medium text-slate-700">Slug</span>
            <input id="slug"
              class="mt-1 w-full rounded-xl border-slate-300 font-mono focus:border-ocean-500 focus:ring-ocean-500"
              placeholder="budget-antifouling" required />
            <p class="text-xs text-slate-500 mt-1">
              Auto-generated from title — you can edit.
            </p>
          </label>
        </div>

        <label class="block">
          <span class="text-sm font-medium text-slate-700">Excerpt</span>
          <textarea id="excerpt" rows="2"
            class="mt-1 w-full rounded-xl border-slate-300 focus:border-ocean-500 focus:ring-ocean-500"
            placeholder="Short teaser shown in lists"></textarea>
        </label>

        <div class="grid md:grid-cols-3 gap-4">
          <label class="block">
            <span class="text-sm font-medium text-slate-700">Category</span>
            <select id="category"
              class="mt-1 w-full rounded-xl border-slate-300 focus:border-ocean-500 focus:ring-ocean-500">
              <option>Maintenance</option>
              <option>Painting</option>
              <option>Fibreglass</option>
              <option>Budget</option>
              <option>Safety</option>
              <option>DIY</option>
            </select>
          </label>
          <label class="block">
            <span class="text-sm font-medium text-slate-700">Read time (min)</span>
            <input id="minutes" type="number" min="1" value="6"
              class="mt-1 w-full rounded-xl border-slate-300 focus:border-ocean-500 focus:ring-ocean-500" />
          </label>
          <label class="block">
            <span class="text-sm font-medium text-slate-700">Tags</span>
            <input id="tagsInput"
              class="mt-1 w-full rounded-xl border-slate-300 focus:border-ocean-500 focus:ring-ocean-500"
              placeholder="antifouling, paint, money" />
            <div id="tags" class="mt-2 flex flex-wrap gap-2"></div>
          </label>
        </div>

        <!-- Cover image -->
        <label class="block">
          <span class="text-sm font-medium text-slate-700">Cover image</span>
          <input id="coverFile" type="file" accept="image/*" class="mt-1 block w-full rounded-xl border-slate-300" />
          <div id="coverPreview" class="mt-2 text-sm text-slate-600"></div>
        </label>

        <!-- Upload inline image (inserts Markdown at cursor) -->
        <div class="flex items-center gap-2">
          <button id="btnUploadInline" type="button"
            class="rounded-xl px-3 py-2 border border-slate-300 hover:bg-slate-50">
            Upload inline image
          </button>
          <span class="text-xs text-slate-500">Inserts <code>![alt](url)</code> at cursor</span>
        </div>

        <label class="block">
          <span class="text-sm font-medium text-slate-700">Body (Markdown)</span>
          <textarea id="body" rows="16"
            class="mt-1 w-full rounded-xl border-slate-300 font-mono leading-6 focus:border-ocean-500 focus:ring-ocean-500"
            placeholder="## Heading
            Your content here…"></textarea>
        </label>

        <div class="flex items-center gap-3">
          <button id="saveBtn" type="submit" class="rounded-xl px-5 py-3 bg-kelp-500 text-white hover:brightness-95">
            Save
          </button>
          <button id="resetBtn" type="button" class="rounded-xl px-5 py-3 border border-slate-300 hover:bg-slate-50">
            Reset
          </button>
          <span id="saveStatus" class="text-sm text-slate-500"></span>
        </div>
      </form>
    </section>

    <!-- Preview -->
    <aside class="card bg-white border border-slate-200 rounded-2xl p-6">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-bold">Preview</h2>
        <label class="text-sm text-slate-600"><input id="autoPreview" type="checkbox" class="mr-2" checked />
          Auto-update</label>
      </div>
      <article class="prose max-w-none mt-4">
        <h3 id="pTitle" class="text-2xl font-semibold">—</h3>
        <p id="pExcerpt" class="text-slate-600">—</p>
        <div class="mt-2 flex items-center gap-2 text-xs text-slate-600">
          <span id="pCategory"
            class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-slate-100 border border-slate-200">Category</span>
          <span id="pTags" class="flex flex-wrap gap-2"></span>
          <span id="pMinutes"
            class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-slate-100 border border-slate-200">⏱️ 0
            min</span>
        </div>
        <hr class="my-4" />
        <div id="pBody" class="prose"></div>
      </article>
    </aside>
  </main>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 hidden">
    <div class="rounded-xl bg-ocean-900 text-white px-4 py-2 shadow-lg">
      Saved!
    </div>
  </div>

  <script>
    // ======= Supabase init (runtime via Netlify function) =======
    let supabase;
    async function initSupabase() {
      const res = await fetch('/.netlify/functions/public-config', {
        cache: 'no-store'
      });
      if (!res.ok) {
        alert('Failed to load config');
        return;
      }
      const {
        SUPABASE_URL,
        SUPABASE_ANON_KEY
      } = await res.json();
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }

    // ======= Guard: admin only =======
    async function requireAdmin() {
      const {
        data: {
          user
        }
      } = await supabase.auth.getUser();
      if (!user) {
        location.assign('/admin/login.html');
        return false;
      }
      const {
        data,
        error
      } = await supabase.from('profiles').select('is_admin').eq('id', user.id).maybeSingle();
      if (error || !data?.is_admin) {
        await supabase.auth.signOut();
        location.assign('/admin/login.html');
        return false;
      }
      document.getElementById('userEmail').textContent = user.email || '';
      return true;
    }

    // ======= Auth top-right =======
    document.getElementById('signOut').onclick = async () => {
      await supabase.auth.signOut();
      location.assign('/admin/login.html');
    };

    // ======= Editor state =======
    const el = id => document.getElementById(id);
    const title = el('title');
    const slug = el('slug');
    const excerpt = el('excerpt');
    const category = el('category');
    const minutes = el('minutes');
    const tagsInput = el('tagsInput');
    const tagsWrap = el('tags');
    const body = el('body');
    const saveBtn = el('saveBtn');
    const saveStatus = el('saveStatus');
    const coverFile = el('coverFile');
    const btnUploadInline = el('btnUploadInline');

    let current = {
      slug: '',
      title: '',
      excerpt: '',
      category: 'Maintenance',
      minutes: 6,
      tags: [],
      body: ''
    };

    function toSlug(s) {
      return s.toLowerCase().trim().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '-').replace(/-+/g, '-');
    }

    function renderTags(list) {
      tagsWrap.innerHTML = '';
      (list || []).forEach((t, i) => {
      const b = document.createElement('button');
        b.type = 'button';
        b.className =
          'inline-flex items-center gap-1 px-2 py-1 rounded-full bg-slate-100 border border-slate-200 text-xs';
        b.textContent = t;
        b.title = 'Remove tag';
        b.onclick = () => {
          current.tags.splice(i, 1);
          renderTags(current.tags);
          updatePreview();
        };
        tagsWrap.appendChild(b);
      })
    }

    tagsInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ',') {
        e.preventDefault();
        const v = tagsInput.value.trim().replace(/,$/, '');
        if (v && !current.tags.includes(v)) current.tags.push(v);
        tagsInput.value = '';
        renderTags(current.tags);
        updatePreview();
      }
    });

    // ======= Preview wiring =======
    const autoPreview = el('autoPreview');
    const pTitle = el('pTitle');
    const pExcerpt = el('pExcerpt');
    const pCategory = el('pCategory');
    const pTags = el('pTags');
    const pMinutes = el('pMinutes');
    const pBody = el('pBody');

    function updatePreview() {
      try {
        pTitle.textContent = title.value || '—';
        pExcerpt.textContent = excerpt.value || '—';
        pCategory.textContent = category.value || '—';
        pTags.innerHTML = (current.tags || []).map(t =>
          `<span class='inline-flex items-center gap-1 px-2 py-1 rounded-full bg-slate-100 border border-slate-200 text-xs'>${t}</span>`
          ).join(' ');
        pMinutes.textContent = `⏱️ ${Number(minutes.value||0)} min`;
        const md = body.value || '';
        const parse = (window.marked && window.marked.parse) ? window.marked.parse : (s => s);
        pBody.innerHTML = parse(md);
      } catch (err) {
        console.error('Preview error:', err);
      }
    }

    // Live update wiring (and slug autofill)
    title.addEventListener('input', () => {
      if (!slug.dataset.touched) {
        slug.value = toSlug(title.value);
      }
      if (autoPreview?.checked !== false) updatePreview();
    });
    slug.addEventListener('input', () => {
      slug.dataset.touched = '1';
    });
    body.addEventListener('input', () => {
      if (autoPreview?.checked !== false) updatePreview();
    });
    excerpt.addEventListener('input', () => {
      if (autoPreview?.checked !== false) updatePreview();
    });
    category.addEventListener('change', () => {
      if (autoPreview?.checked !== false) updatePreview();
    });
    minutes.addEventListener('input', () => {
      if (autoPreview?.checked !== false) updatePreview();
    });
    autoPreview?.addEventListener('change', () => {
      if (autoPreview.checked) updatePreview();
    });

    function syncToForm(a) {
      current = {
        ...current,
        ...a
      };
      title.value = a.title || '';
      slug.value = a.slug || '';
      excerpt.value = a.excerpt || '';
      category.value = a.category || 'Maintenance';
      minutes.value = a.minutes || 6;
      body.value = a.body || '';
      renderTags(a.tags || []);
      updatePreview();
    }

    el('resetBtn').onclick = () => {
      syncToForm({
        slug: '',
        title: '',
        excerpt: '',
        category: 'Maintenance',
        minutes: 6,
        tags: [],
        body: ''
      });
    };

    // ======= Save (single, robust handler) =======
    async function handleSave(e) {
      try {
        e.preventDefault();
        if (!supabase) {
          alert('Not ready yet. Try again.');
          return;
        }

        const payload = {
          slug: slug.value.trim(),
          title: title.value.trim(),
          excerpt: excerpt.value.trim(),
          body: body.value,
          category: category.value,
          tags: current.tags,
          minutes: Number(minutes.value || 6),
          cover_url: current.cover_url || null,
          // gallery: current.gallery || []   // optional, if you add UI for multiple images
        };
        if (!payload.slug || !payload.title) {
          alert('Title and slug are required.');
          return;
        }

        const {
          data: {
            session
          }
        } = await supabase.auth.getSession();
        if (!session) {
          alert('Session expired. Please sign in again.');
          location.assign('/admin/login.html');
          return;
        }

        saveBtn.disabled = true;
        saveStatus.textContent = 'Saving…';

        const ctrl = new AbortController();
        const t = setTimeout(() => ctrl.abort(), 20000);

        const res = await fetch('/.netlify/functions/upsert-article', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session.access_token}`
          },
          body: JSON.stringify(payload),
          signal: ctrl.signal
        });

        const text = await res.text();
        if (!res.ok) {
          console.error('Save error', res.status, text);
          alert(`Save failed (${res.status}): ${text}`);
          return;
        }
        showToast('Saved');
      } catch (err) {
        if (err.name === 'AbortError') alert('Save timed out.');
        else alert(`Save error: ${err.message || String(err)}`);
      } finally {
        saveBtn.disabled = false;
        saveStatus.textContent = '';
      }
    }

    function showToast(msg) {
      const t = document.getElementById('toast');
      t.firstElementChild.textContent = msg;
      t.classList.remove('hidden');
      setTimeout(() => t.classList.add('hidden'), 1400);
    }

    // Build a safe path and upload a file to Supabase Storage (public bucket)
    async function uploadFileToBucket(file, subpath) {
      if (!file) throw new Error('No file selected');
      const {
        data: {
          user
        }
      } = await supabase.auth.getUser();
      if (!user) throw new Error('Not signed in');

      // Clean names
      const cleanSlug = (slug.value || 'untitled').toLowerCase().replace(/[^a-z0-9-]/g, '-');
      const cleanName = file.name.replace(/[^a-zA-Z0-9._-]/g, '_');

      const path = `${user.id}/${cleanSlug}/${subpath}/${Date.now()}-${cleanName}`;
      const {
        data,
        error
      } = await supabase.storage
        .from('article-images')
        .upload(path, file, {
          cacheControl: '3600',
          upsert: false
        });

      if (error) throw error;

      // Get a public URL
      const {
        data: pub
      } = supabase.storage.from('article-images').getPublicUrl(data.path);
      return pub.publicUrl; // e.g. https://xyz.supabase.co/storage/v1/object/public/article-images/...
    }

    async function onCoverSelected() {
      const f = document.getElementById('coverFile').files?.[0];
      if (!f) return;
      try {
        const url = await uploadFileToBucket(f, 'cover');
        // store for submit + show preview
        current.cover_url = url;
        const wrap = document.getElementById('coverPreview');
        wrap.innerHTML = `<img src="${url}" alt="Cover" class="mt-2 max-h-40 rounded-lg border border-slate-200" />
                      <div class="text-xs text-slate-600 break-all mt-1">${url}</div>`;
      } catch (e) {
        alert(`Cover upload failed: ${e.message || e}`);
      }
    }

    function insertAtCursor(textarea, text) {
      const start = textarea.selectionStart ?? textarea.value.length;
      const end = textarea.selectionEnd ?? textarea.value.length;
      const before = textarea.value.slice(0, start);
      const after = textarea.value.slice(end);
      textarea.value = before + text + after;
      // put cursor after inserted text
      const pos = start + text.length;
      textarea.selectionStart = textarea.selectionEnd = pos;
      textarea.focus();
      updatePreview();
    }

    async function uploadInlineImage() {
      // prompt for file via hidden input
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = async () => {
        const f = input.files?.[0];
        if (!f) return;
        try {
          const url = await uploadFileToBucket(f, 'inline');
          // Insert Markdown at cursor
          const alt = prompt('Alt text for the image?', '') || 'image';
          insertAtCursor(body, `![${alt}](${url})`);
        } catch (e) {
          alert(`Image upload failed: ${e.message || e}`);
        }
      };
      input.click();
    }

    // ======= Boot =======
    (async function boot() {
      await initSupabase();
      const ok = await requireAdmin();
      if (!ok) return; // redirected

      supabase.auth.onAuthStateChange(async () => {
        const {
          data: {
            user
          }
        } = await supabase.auth.getUser();
        if (!user) location.assign('/admin/login.html');
      });

      const form = document.getElementById('editor');
      form.addEventListener('submit', handleSave);
      coverFile.addEventListener('change', onCoverSelected);
      btnUploadInline.addEventListener('click', uploadInlineImage);

      syncToForm(current);
      updatePreview();
    })();
  </script>
</body>

</html>